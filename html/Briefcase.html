<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"/>
<meta http-equiv="Cache-Control" content="no-store"/ />
<meta http-equiv="Pragma" content="no-cache"/ />
<title>ODK Briefcase</title>
</head>
<body>
<h1>Download data from ODK Aggregate</h1>
<p>Creates .csv files and binary data files on your local filesystem.</p>
<p><a href="#IEIssue"><b>Does not work in Internet Explorer!</b></a></p>
<p>You must already be logged into Aggregate from within this browser in order to access the uploaded data.</p>
<h3>Retrieving all data</h3>
<p>Repeat the following steps for all form identifiers:</p>
<ol>
<li>Specify a download directory location (this cannot already contain downloaded data).</li>
<li>Enable downloading of nested repeat groups.</li>
<li>Choose `Download binary data and replace server URL with the local filename in the csv` (e.g., images, audio, video).</li>
<li>Cut-and-paste the URL for the Aggregate website (don't forget to browse to that website and log in!)</li>
<li>For the odkId, specify a form identifier (shown on Aggregate's List Forms page).</li>
<li>Choose `Retrieve`</li>
<li>Repeat for all form identifiers.</li>
</ol>
<object type="application/x-java-applet" height="600" width="700" >
  <param name="jnlp_href" value="opendatakit-briefcase.jnlp" />
</object>
<h3>About the OdkId</h3>
<p>The basic structure of an odkId is:</p>
<pre>form-identifier/top-level-tag/repeat-group/nested-repeat-group/...</pre>
<p>Where:</p><ul>
<li><code>form-identifier</code>: the form identifier shown on the List Forms page.</li>
<li><code>top-level-tag</code>: the name of the top-level data tag (the one with the <code>form-identifier</code> as an id attribute value or xmlns name).</li>
<li><code>repeat-group</code>: the name of a repeating data tag within the <code>top-level-tag</code> instance.</li>
<li><code>nested-repeat-group</code>: the name of a repeating data tag nested within the <code>repeat-group</code>, above.</li>
</ul>
<p>An xpath-like filter condition can be applied to the last and next-to-last elements of the odkId. The only filter criteria
 currently supported filters on the unique key of a data record.  For example:</p>
<ul>
<li><code>HouseholdSurvey1/HouseholdSurvey/ChildrenOfHousehold</code> returns all <code>ChildrenOfHousehold</code> data for all submitted <code>HouseholdSurvey1</code> forms (all children in all households).</li>
<li><code>HouseholdSurvey1/HouseholdSurvey/ChildrenOfHousehold[@key="bb"]</code> returns the single <code>ChildrenOfHousehold</code> with the unique key "bb" (a specific child).</li>
<li><code>HouseholdSurvey1/HouseholdSurvey[@key="aaa"]/ChildrenOfHousehold</code> returns all <code>ChildrenOfHousehold</code> data that are associated with the <code>HouseholdSurvey</code> with unique key "aaa" (all the children of a single household).</li>
</ul>
<h3>Resuming a failed download attempt</h3>
<p>If your download begins fetching files and fails before completing the retrieval, the <code>Manifest.txt</code> file in your download directory 
will contain information like this:</p>
<pre>
BriefcaseVersion: 1.0
RunDate: Aug 10, 2010
ServerUrl: http://localhost:8888/
OdkId-1: HouseholdSurvey1/HouseholdSurvey/ChildrenOfHousehold
CsvFileName-1: \csvData\ChildrenOfHousehold.HouseholdSurvey.HouseholdSurvey1.csv
OdkId-2: HouseholdSurvey1/HouseholdSurvey
CsvFileName-2: \csvData\HouseholdSurvey.HouseholdSurvey1.csv
LastCursor-2: E9oBpgFqoAFqC29wZW5kYXRha2l0cpABCxJjCgAaI0hvdXNlaG9sZFN1cnZleTFDaGlsZHJlbk9mSG91c2Vob2xkIzAFcjYaClBBUkVOVF9LRVkgAComY2oLb3BlbmRhdGFraXRzehBIb3VzZWhvbGRTdXJ2ZXkxgAECdGQkDAsSI0hvdXNlaG9sZFN1cnZleTFDaGlsZHJlbk9mSG91c2Vob2xkGAUMggEA4AEAFA
LastKEY-2: http://localhost:8888/csvFragment?odkId=HouseholdSurvey1%2FHouseholdSurvey%5B%40key%3D%22agtvcGVuZGF0YWtpdHIWCxIQSG91c2Vob2xkU3VydmV5MRgCDA%22%5D
Completion-Status: Failure
</pre>
<p>To resume the fetch, simply locate the `LastCursor-x:` field (there will be only one in the file), copy its value into the `LastCursor-x:` prompt above,
 and do the same for the corresponding `LastKEY-x:` and `OdkId-x:` fields.</p>
<p>Resumed fetches must download data to a new download directory.  While the applet ensures that
 the top-level form entries are never duplicated and that processing picks up where it ended,
  there may be duplicates in the repeated groups and binary data within the top-level form.</p>
<p> Resolving the duplicates is a manual process.  Binary data files have repeatably unique 
names and can simply be consolidated into a single directory; any duplicates should be identical 
copies of the same file.  The csv files should be manually concatenated then sorted by their 
rightmost column (the KEY) column), and any duplicate rows removed.</p>
<h2>Known Issues</h2>
<h3>Csv file contents</h3>
<p>The csv files should be interpreted as containing UTF-8 characters. Unfortunately, browsing to the file
and double-clicking to open Excel will cause them to be loaded into a spreadsheet with the default ANSI
character encoding.  Instead, you need to:</p>
<ol><li>Open the Excel 2007 application</li>
<li>create a new workbook or open an existing workbook</li>
<li>choose Data/Import Text</li>
<li>Browse to the downloaded .csv file; hit Open</li>
<li><b>Text Import Wizard - Step 1 of 3</b> opens.</li>
<li>Choose `Delimited`</li>
<li>Under `File origin:` select <code>65001 : Unicode (UTF-8)</code></li>
<li>Hit Next to advance to <b>Text Import Wizard - Step 2 of 3</b></li>
<li>Choose only `Comma` for the delimiters.</li>
<li>Uncheck the `Treat consecutive delimiters as one` checkbox</li>
<li>Hit Finish or, choose Next to define the formatting you want.</li></ol>
<p>The data will now be loaded into Excel 2007 with UTF-8 characters properly interpreted.</p>
<h3><a name="IEIssue">Internet Explorer</a></h3>
<p>This applet will not work on IE 8, and likely not on any earlier IE version.  The reason is that
the authentication cookie created by the appspot login process does not have the P3P access settings
to allow the applet to utilize the cookie for its requests to Aggregate.  This causes the applet to
repeatedly see the `Login Required` screen.</p>
<p>The recommended work-around is to use Firefox or Chrome.  If you must use IE, you can get it to 
work by going to Tools/Internet Options.  Choose the Security tab.  Uncheck `Enable Protected Mode`
and restart IE.  You will now be able to download.  However, immediately upon completing the 
download, you should re-enable protected mode.  There are simply too many ways IE can break and 
you system will be compromised if you browse without this enabled.</p>
</body>
</html>